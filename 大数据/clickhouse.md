# clickhouse

## clickhouse 适用场景

适合场景：适合分析结构化的、不可变的流式数据。例如打点日志分析、行为分析等, 能够针对结构化数据，快速给出聚合/过滤结果
不适合场景：事务操作、二进制文件或数据存储、键值对数据高效率访问等

OLAP场景关键特征

- 大多数是读请求
- 总是批量(>1000 rows)进行写入
- 每次查询仅需要少量的列
- 处理单个查询需要高吞吐量
- 事务不是必须的
- 不修改已添加的列

## clickhouse 为什么查询速度快

Clickhouse是一个列式存储的数据库,主要有以下几个方面使其查询速度很快:

- 列式存储。Clickhouse存储的数据是按列存储的,不是按行存储的。这样查询只需要读取相关的列,可以减少IO和解码的数据量。特别是在有大量的列,但查询只需要少数几列的情况下,效果更加明显。
- 压缩编码。Clickhouse对列进行压缩编码,这样可以减小存储空间和读取的数据量。其支持的压缩编码有多种,如ZSTD编码,LZ4压缩等。
- 向量化执行。Clickhouse可以一次性处理一整行数据,不需要一次处理一条记录。这样可以充分利用CPU的SIMD指令,提高运算效率。
- 索引技术。Clickhouse支持多种索引结构, 包括稀疏索引（索引粒度为8192）,Hash索引、布隆过滤器, Roaring Bitmaps压缩位图索引等，这些索引可以提高查询性能和过滤器效率。
- 缓存技术。Clickhouse deploy有层层缓存,从CPU缓存,到系统缓存,以及Clickhouse自带的缓存。这些缓存可以减少去disk读取数据,加速查询。
- 表引擎特性。Clickhouse提供的表引擎有MergeTree,AggregatingMergeTree,SummingMergeTree等,这些表引擎具有一定的预聚合和分区特性,也可以加速查询。
- 分布式架构。ClickHouse是一种分布式数据库，可以在多个节点上运行。每个节点都可以处理数据，并且可以通过网络进行通信。这种架构可以提高查询速度和可扩展性。
- 支持JIT。 just in-time compilation,动态编译，runtime code generation, 将复杂的表达式即时编译成机器码执行

综上,Clickhouse通过列式存储、压缩编码、向量化执行、索引技术、缓存技术、特定的表引擎以及分布式架构,实现了减少IO、减少计算量和利用Cache,最终达到提高查询效率的目的。这也是Clickhouse作为一款OLAP数据库可以达到亚秒级查询的关键所在。

## clickhouse架构

## clickhouse问题

- 不能支持高频查询。默认100qps
- 非存算分离架构。计算和存储耦合。存储和计算资源无法独立扩展
- 资源隔离困难
- 不具备弹性能力。开源的clickhouse集群没有数据自动均衡功能（rebalance）
- 运维成本高。shared-nothing架构，节点之间并不会同步关键信息，用户向集群新增节点后，增量节点并不会自动从存量节点上继承schema信息，导致易用性差
- 不支持事务, 复杂查询性能差