# Nginx

> nginx是一款高性能,轻量级的web服务器, 反向代理服务器

- 正向代理: 代理的是客户端
- 反向代理: 代理的是服务器

## 技术原理

### 进程模型

- 单个master: 读取并验证nginx配置文件, 管理worker进程
- 多个worker: 每个worker维护一个线程（避免线程切换）, 处理连接和请求。worker的数量由配置文件决定, 一般和cpu个数相关

### 平滑重启

- 接收到hub信号后, 重新加载配置文件
- 启动的新的worker进程
- 向老的worker进程发送信号, 告诉他们处理完当前请求后就退出, 不再接受新的请求
- 新的worker启动后, 就开始接受新的请求
- 老的woker处理完成进程后, kill掉即可

### 高性能

- 采用同步非堵塞(epoll)模型, epoll不会遍历所有的fd, 只会遍历活跃的, 加入到ready状态的fd, epoll的io效率不会随fd数目增加而线性降低, 更多的并发数只是会占用更多的内存而已。当有大量的idle-connection时, 效率会更高
- 多进程模型, 使用自旋锁解决惊群问题。多进程同时listen会产生了所谓的惊群效应, 当内核accept一个连接时, 会唤醒所有等待中的进程, 但实际只有一个进程能获取连接, 其他的进程都是无效唤醒。 nginx多进程的锁在底层通过cpu自旋锁来实现, 如果操作系统不支持自旋锁, 就采用文件锁。谁拿到锁, 谁才将accept的fd加入到epoll队列, 其他的子进程拿不到锁, 就不会把fd加入到epoll中, 接下来也不会有所有子进程的epol被唤醒返回
- 所有定时事件时存放在红黑树中。

### 高可用

keepalive + nginx实现高可用，通过VIP

event模块的主要功能就是 监听accept后建立的连接, 对读写事件进行添加删除。 事件处理模型和nginx的 非阻塞IO模型结合在一起使用。 当IO可读可写时, 相应的读写事件就会被唤醒。 此时就会去处理事件的回调函数

## 配置

分为核心模块、基础模块与第三方模块。

- 核心模块: Http、Event、Mail
- 基础模快: Http Access, Http Proxy, Http Rewrite
- 第三方模块: HTTP Upstream Reuest Hash模块、Notice模块 Access Key模块

从功能上分: 处理模块、过滤模块、代理模块

### 配置模块

- main: 全局配置, 影响所有配置
- server: 主机配置, 影响指定主机与端口
- upstream: 负载均衡配置,
- location: url匹配特定位置配置

### 用法

- ~表示区分大小写的匹配,  ~*表示不区分大小写的匹配
- ~!表示区分大小写的不匹配,  ~*！表示不区分大小写的匹配
- last表示完成rewrite, 再次对server进行匹配, break表示完成rewrite, 不再匹配

nginx负载均衡支持4种调度算法

- 轮询
- ip hash
- weight
- fai, 按照页面加载时间长短与页面大小