# 安全设计

## 整体安全分层设计

从系统整体的安全考虑，可以分为：

- 结构安全
- 通讯安全
- 访问安全
- 数据安全
- 实现安全

以上5个层面进行分析设计。

## 结构安全

总体方针：**安全分区、网络专用、横向隔离、纵向认证**

客户场景下，整体系统可能会由一个中心、多个区域和部份三级节点组成。每个节点包括对上下级的级联和对接其它的安全设备。

其它安全设备作为输入输出：

- 输入： 设备的处理日志、采集的网络数据(流量) 、安全特征查询等。用于安全威胁和行为的分析。**输入数据没有可执行性**。
- 输出： 控制指令(`OpenC2`)，指挥设备进行识别、防御、分析、响应、恢复(`IPDRR`)的操作。

### 系统结构安全威胁分析

| 安全风险                       | 影响                                                           | 概率 | 后果 | 方案                                                                              |
| ------------------------------ | -------------------------------------------------------------- | ---- | ---- | --------------------------------------------------------------------------------- |
| ACK-1 伪安全设备的流量攻击     | 系统负载高，真实数据可能会丢失                                 | 微小 | S3   | 1. 接入端信任机制 </br> 2. 熔断机制                                               |
| ACK-2 利用通讯恶意控制安全设备 | 安全设备被恶意控制，无法起到作用，会被进一步渗透和产生未知威胁 | 微小 | S0   | 1. 数据与指令通讯通道分离 </br> 2. 指令进行审计，指令接收端有手动开关控制         |
| ACK-3 上级系统恶意控制下级系统 | 下级系统被恶意控制，系统可能失效，会并进一步渗透和产生未知威胁 | 微小 | S0   | 1. 级联数据与级联指令通讯通道分离 </br> 2. 指令进行审计，指令接收端有手动开关控制 |

### 结构安全关键设计

1. 安全设备的接入数据与指令通讯通道分离
2. 节点间的级联数据与级联指令的通讯通道分离
3. 指令通讯进行审计与开关控制
4. 安全设备接入信用机制，并有熔断机制

## 通讯安全

| 威胁分类 | 影响                                                 | 方案                                                                                                                    |
| -------- | ---------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| 窃听     | 非法用户通过拦截或抓取通讯过程中数据包来获取机密数据 | 系统间以及前后端的通讯都采用`HTTPS`或`TLS`进行通道加密</br>传输过程中关键、敏感数据对数据本身再进行加密                 |
| 篡改     | 非法用户对发送中的消息内容进行修改                   | 通讯过程发送者对请求进行签名，接受者验证请求签名是否一致，防止签名被篡改                                                |
| 伪装     | 非法用户冒充合法用户接收与发送消息给系统             | 认证系统必须具备多因子认证机制，且认证因子应该尽量与用户进行物理的绑定，如**基于手机的`token`、短信验证码**，`USBKEY`等 |
| 抵赖     | 用户对于发送的信息进行否认，不承认发送了该消息       | 用户的所有操作都记录到审计日志中</br>接受的日志和数据都记录来源的组织信息                                               |

## 访问安全

- 用户
- 第三方系统
- 运维工程师

### 访问安全威胁分析

| 安全风险                     | 影响                                                                                                                         | 方案                                                                                                                                                                                                                                                                          |
| ---------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 系统对外暴露可访问的端口过多 | 1. 暴露面过多，每个暴露的端口和协议都会带来安全隐患 </br> 2. 系统容易被通过扫描等方式暴露系统的敏感信息                      | 1. 减少暴露面，只提供必要的端口对外（443,22）</br> 2. 修改暴露端口和协议的描述，减少敏感信息                                                                                                                                                                                  |
| 未授权访问请求               | 1. 未授权用户可以直接访问，从而引发重要权限可被操作、数据库、网站目录等敏感信息泄露。                                        | 1. 所有接口必须通过API Gateway对外发布，API Gateway统一进行接口认证授权 </br> 2. 建立统一的访问控制机制 </br> 3. 只有少数的无需授权的接口，如Login                                                                                                                            |
| 暴力破解                     | 1. 攻击者通过暴力破解获得了系统/用户的账号和密码，以此为后续的入侵做准备 </br> 2. 导致系统信息泄露、系统被恶意控制等高危事件 | 1. 输错密码几次就锁定一段时间 </br> 2. 通过验证码技术要求用户完成任务才能登录到系统，用户可以轻松完成，但暴力工具无法完成。例如图形验证码等 </br> 3. 强制用户设置长而复杂的密码，并强制定期更改密码 </br> 4. 结合两种不同的认证因素对用户进行认证的方法。例如密码、安全令牌等 |
| 请求重放                     | 1. 攻击者获取系统敏感信息 </br> 2. 伪造真实用户制造恶意攻击事件                                                              | 1. 每次请求都通过时间戳等形成请求摘要，并验证摘要的有效性 </br> 2. 必须通过HTTP's对外提供服务                                                                                                                                                                                 |
| SQL注入                      | 1. 数据库被拖库 </br> 2. 通过SQL注入漏洞直接获取webshell或者执行命令导致服务器系统权限被获取。                               | 1. 应用的数据库权限进行限制，使用应用专用的账号进行数据库访问 </br> 2. 对输入进行严格的转义和过滤 </br> 3. 使用ORM框架的参数化（Parameterized）解决注入问题,禁止使用"SQL拼接"的方式                                                                                           |

### 访问安全设计

#### 系统访问安全

如果将系统看成一个黑盒子，用户需要对系统访问的需求只有两类。

1. 应用的使用者：通过`HTTP's`协议来使用应用系统所提供的产品服务
2. 系统的维护者：通过`SSH`协议来对系统进行诊断、修复

要求：

1. 只对外暴露`HTTP's`和`SSH`服务
2. `SSH`监听的端口不能使用默认的`22`端口（建议采用`RUST`实现一个`SSH Server`，[thrussh](https://docs.rs/thrussh/0.32.7/thrussh/)）

#### 访问控制机制

为了保证访问安全，需要设计系统的“访问控制机制”。

1. 系统在初始化配置过程中，首先需要对系统中的主体（用户/用户组）和客体（接口/文件/数据表）进行登记
2. 设置访问控制安全策略，按照“主体+操作+客体”的格式进行授权，规定主体在运行时对客体的操作，形成访问控制列表
3. 用户登录系统时，首先进行身份鉴别，确认合法的用户可登录系统，并执行相应程序
4. 当程序发出访问系统中客体资源的请求后，主动访问控制安全机制将其截获其请求，然后查询对应的访问控制列表。如符合权限，则允许放行；否则将拒绝执行，并将此行为记录在审计记录中。

**针对不同的客体类型（接口/文件/数据表），设计了不同的访问控制的方案。**

#### 认证安全设计

对于使用应用的实体，不管是人还是系统程序，都应当做到每个请求都能找到对应的责任实体。

- 登录页面/接口应该有防刷机制（比如验证码），防止暴力破解
- 应当具备多因子，该因子应该尽量与使用者物理绑定，比如**基于手机的`token`、短信验证码**等，比如**基于特定物理设备的`USBKEY`**等，比如**基于人体特征的刷脸**等，防止密码泄露的后果影响
- 多次登录尝试失败之后，应当锁定账户或IP，不再允许登录
- 采用增强的密码管理策略，如拒绝弱密码、密码最小长度要求、字符集要求、定期更改密码要求等

#### SQL注入

- 应用的数据库权限进行限制，使用应用专用的账号进行数据库访问，不允许使用如Sysadmin、sa等超级管理员账号访问数据库
- 对用户的输入进行严格的转义和过滤
- 使用ORM框架的参数化（Parameterized）解决注入问题,禁止使用"SQL拼接"的方式

## 数据安全

### 数据保密方案

#### 数据加解密

1. 对敏感数据进行加密处理并存储，系统中降低客户信息泄露的风险 。系统需要支持可逆加密算法和不可逆加密算法。可逆加密算法用于将来可能输出的信息，不可逆算法用于和外部系统进行关联匹配时使用。
2. 用于与外部系统管理的不可逆的信息可采用`HASH`算法进行加密

**建议采用国家密码主管部门要求的加密算法(`SM2`、`SM4`等)，或使用其他低风险算法（`SHA256`、`AES256`、`RSA2048`）等，不要使用不安全的加密算法：DES、3DES、AES128、RSA1024。**

#### 数据脱敏

对部分客户敏感信息进行脱敏处理，在数据共享过程中降低客户信息泄露的风险。
脱敏规则包括以“*”等字符隐掉部分信息，或把信息替换成其他内容等。
脱敏规则主要应用在前端、API Gateway、日志等对外输出的部分。

### 数据可用方案

- 数据多副本方案
- 数据备份/恢复方案

### 数据备份

在大数据场景下，数据量通常较大，数据还会不断增加，实现全量备份的代价较大，并且也有大数据的多副本的方案，建议只对业务数据进行备份。

备份介质可以基于不同的数据量和成本考虑采取不同的方案。

- 本地磁盘（数据量较小）
- 外接备份服务器或磁带机（数据量大）

在备份规划时，要识别关键数据，至少需要包括系统的管理数据、元数据、配置数据等。

在备份工作结束后需要提供备份状况报告，并定期进行备份数据检测。

### 数据恢复

系统可以提供数据恢复的命令工具，由运维人员进行操作。

### 不同的数据类型的处理方案

- 非单机环境的数据进入分布式存储
- 永久保持数据，只能进行逻辑删除处理。
- 安全日志等大数据量的数据，需要通过第三方备份系统进行数据备份

## 实现安全

### 实现安全威胁分析

| 威胁因素         | 后果                                                       | 概率 | 方案                                                                                                                                         |
| ---------------- | ---------------------------------------------------------- | ---- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| 编写的非安全代码 | 系统留下安全隐患，如0day漏洞等                             | 大   | 1. 在`Gitlab CI Pipeline`中集成`Sonar`，进行代码静态扫描，减少代码结构中的安全漏洞 </br> 2. 通过定期的分析，减少代码中的安全漏洞             |
| 开源非安全代码   | 系统引入未知的安全隐患，导致系统被攻击后失效和被进一步渗透 | 大   | 1. 采用统一的开发框架将开源组件管理起来</br>2. 定期评估开源组件，避免引入有安全漏洞的开源组件                                                |
| 制品被感染       | 系统引入未知的安全隐患，导致系统被攻击后失效和被进一步渗透 | 大   | 1. 在生成制品之后，通过病毒查杀，来排除制品中被病毒和木马感染的风险</br> 2. 每个制品都有制品的SHA256的校验和文件，保障制品在下载后的数据一致 |
| 系统运行时漏洞   | 系统容易被攻击，导致系统被攻击后失效和被进一步渗透         | 大   |                                                                                                                                              |

### 实现安全整体方案

1. 在开发过程中，使用统一的代码框架，Sonar`，发现和解决开发过程中的自有代码和三方代码的安全问题
2. 设定代码漏洞的监测机制，打通漏洞情报和项目中漏洞的信息衔接，指派专人来对开源组件的漏洞进行监测
3. 在开发完成之后，使用病毒查杀来发现和解决制品中的安全问题
4. 在系统运行时，采用加特林的攻击测试和通过公司的安全测试，来解决运行时的安全问题