# 业务应用管理

> 该文档主要明确应用接入的准入标准。文档中包含了已有的规范、约定和最佳实践。不包含标准设定的详细原因以及具体执行步骤

## 目标

明确应用开发/集成/部署/运行/测试/配置管理等阶段的平台规范，降低沟通/集成/排错成本，提高平台竞争力

## 规则

**满足规范的应用才能接入平台，否则需进行整改**

## 前置条件

### 代码质量

- 集成组件单元测试覆盖率不应低于 `60%`
- 集成 `java` 组件必须接入 `Sonar`，bugs、漏洞、坏味道数量不得超过限制要求
- 集成组件必须接入公司奇安信开源卫士依赖扫描
- 集成组件必须接入公司奇安信代码卫士代码扫描

### 测试报告

- 集成组件必须提供功能测试报告，无 `P0` `P1` bug，p2级bug修复率95%
- 集成组件必须提供网络安全部安全测试报告，修复全部安全漏洞
- 集成组件必须提供性能测试报告，确保指定资源限制条件下性能符合产品设计预期
- 集成组件必须提供稳定性测试报告，确保在一定压力负载条件下稳定性符合产品设计预期

## 开发规范

### 技术选型限制

- 数据库必须使用 `SQL 95` 规范的 `SQL` 语句, 禁止基于数据库特性的开发
- 关系型数据库支持pg与mysql两种协议
- 消息队列选型必须为 `kafka` ，兼容 `kafka` `2.0.6` 版本
- 大数据相关程序禁止依赖 `HDFS` `Hadoop` `YARN`
- 分布式调度禁止使用 `Apache DolphinScheduler`
- 必须使用 `es6`，禁止使用 `es5` `es7`
- 必须兼容 `redis cluster`

### 开发语言

#### rust规范

- 通过代码静态检查,包括以下检查
- cargo fmt
- cargo fix
- cargo clippy -- -D warnings
- cargo +nightly udeps

详细参考：https://rust-coding-guidelines.github.io/rust-coding-guidelines-zh/

#### java规范

- jdk兼容性
- 兼容 oracle jdk 11
- 兼容 adoptium temurin jdk 11
- 兼容 ibm semeru jdk 11
- 通过 框架预置的 `Checkstyle` 插件检查

### 开发框架

### 接口设计

**服务必须遵循平台统一的接口规范**

### 测试驱动

**遵循TDD开发实践**

### 接口调用

调用服务接口，推荐使用Java语言的sdk，快速接入服务

## 集成规范

### 功能要求

#### 认证

平台提供统一的登录认证入口, **禁止第三方服务集成单独的登录页**

#### 鉴权

##### 功能权限

平台提供统一的功能权限鉴权机制(ABAC), **所有服务必须接入功能权限**

##### 数据权限

平台提供通用的数据权限机制, 支持ck、postgres、es等语法

##### 许可证

平台提供统一的许可证接入，**所有服务必须按照产品设计接入许可证管理系统**

发布到**正式环境一定要用正式环境许可证，不能使用测试环境的许可证**，平台只提供测试联调环境的许可证，发布前一定要完成许可证接入。

参见[接入文档](./license.md)

#### 服务路由

平台提供统一的api入口，**所有对外的接口必须走网关, 禁止将应用以nodeport模式直接对外暴露**

#### 监控

平台要求**所有服务必须暴露prometheus的监控接口**

#### 审计

平台提供统一的审计日志记录机制，并支持通过api或kafka消息两种方式记录, **请使用该方式进行日志审计**

#### 通知

平台支持对外多种消息发送途径, 包括蓝信/短信/邮件/站内信等, **必须使用平台的消息发送机制**

#### 配置管理

系统管理

### DFX要求

#### 性能

- 确保指定资源限制条件下性能符合产品设计预期
- 限制单用户场景下，pg 存储数量不得大于千万级， Transactions Commit 不高于 40/s，慢查询数量不得高于 5个/天
- 限制单用户场景下，redis 调用小于 100 IOPS

#### 稳定性

- 程序没有明显的资源泄露问题
- 在持续进行压力测试的情况下，程序可以支持长期运行
- 在程序崩溃时，重新启动后可以自行恢复程序原有处理流程

#### 扩展性

允许服务实例水平扩展

- 保证接口幂等性
- 使用分布式缓存代替本地缓存，中推荐使用redis
- 使用分布式锁代替多线程锁，中推荐使用redis做分布式锁

#### 安全性

##### 开源卫士

- 标准：高危以上，或者漏洞利用级别为一般或容易的漏洞需全部修复

##### 代码卫士

- 标准：高危和中危都要修复

##### 灵脉扫描

通过灵脉扫描无漏洞

#### 适配性

##### 国产化

- 支持海光 AMD64 架构
- 支持飞腾、鲲鹏 ARM64 架构
- 支持国产化操作系统

##### 数据库

- 不能依赖某个特定的数据库特性, 例如依赖pg对json的支持
- 同时兼容PG/tidb/达梦
- x86/arm的代码分支是同一个, 兼容特性可以通过flag区分，不允许出现多分支

## 部署规范

### 制品规范

#### 名称

- 外部组件: 业务领域-服务名称
- 内部组件
- 资产分析: asset-名称
- 威胁分析: analysis-名称
- 联动响应: interaction-名称
- 支撑组件: system-名称
- 运行框架: framework-名称
- 基础设施: infra-名称

#### 版本号

使用语义化版本号

#### Dockfile

- rust 类程序使用 rust Dockerfile 示例，支持程序与运行时分离
```Dockerfile
FROM docker.af-biz.cn/alpine:3.14
RUN mkdir /app/
ADD target/release/system-audit /app/
WORKDIR /app/
```

- java 类程序使用 java Dockerfile 示例，支持依赖分离、配置分离

```Dockerfile
FROM docker.af-biz.cn/alpine:3.14
RUN mkdir -p /app/resources/
ADD target/system-manager.jar /app/
ADD target/resources /app/resources/
```

```Dockerfile
FROM docker.af-biz.cn/alpine:3.14
RUN mkdir -p /app/lib/
ADD target/lib /app/lib
```

- 程序必须支持多架构镜像，在每个版本同时提供 `x86-64` `ARM64` 两种多架构镜像制品

#### 底包

##### java

- 裁剪依赖：应用服务减少无用依赖引入
- 必须在统一 maven 镜像中打包
- 支持在生产环境 ibm semeru jdk 11 运行

##### rust

- 必须在统一 rust 编译镜像中打包
- 打包时必须使用 `x86_64-unknown-linux-gnu` 目标编译
- 支持在生产环境 rust 运行镜像中运行

#### 制品体积

- java 项目非 lib 镜像不大于 10MB
- rust 项目镜像不大于 50MB

### 运行形态

<span style="color:red;">禁止业务应用运行在非k8s环境</span>

- java 项目以 `jar` 包形态运行在 ibm semeru jdk 11 中
- rust 项目以二进制文件形式以机器码形态运行在 `Ubuntu22.04` 镜像中

### 资源要求

#### 业务应用

超过1C2G 需特殊说明原因

#### 基础服务

超过一般的标准，需提供计算公式与原因

##### es

- 无用户使用情况下定时调用小于 10 IOPS
- 单用户使用情况下小于 50 IOPS

##### pg

- 存储数量不得大于千万级
- Transactions Commit 不高于 40/s
- 慢查询数量不得高于 5个/天

##### zk

- 调用频率不高于 10 IOPS

##### raptor

- 无用户使用情况下定时调用小于 50 IOPS
- 单用户使用情况下小于 100 IOPS

##### redis

- redis 调用小于 100 IOPS

##### minio

- minio 调用小于 10 IOPS
- minio 每天新增存储量小于 10Gb

##### flink

- 预置 sabre 引擎的 flink 集群可任意使用，但总资源限制不得超过机器最大限额
- 自行集成的非预置 flink 集群必须说明具体用途，额外集成

### 发布规范

#### 部署脚本

##### 环境变量

- 所有与环境有关配置必须可以通过配置文件注入，不可硬编码
- 所有变量必须引用对应版本中settings.ini 配置，不可在配置文件中写死
- 对于不在 setting.ini 中声明的变量，必须通过系统配置或者项目前端页面配置，不可自行增加、修改变量

##### 服务发现

- 必须使用基于 svc name 的服务发现机制
- 禁止使用 `etcd` `nacos` `eureka` `gossip` `gossip.v2` 等注册中心

##### 密钥管理

- 关键密钥信息必须存储在对应环境 `secret` 中
- 关键密钥信息需要通过环境变量 `env` 注入
- java 程序应该支持配置文件引用环境变量

## 运行时规范

### 启动依赖

- pg: 数据库由部署脚本创建
- kafka: topic由producer创建
- minio: bucket由hakkero或者主要使用者创建
- 启动时只能依赖设计部署层级比当前部署层级低的组件，不可出现同级启动依赖以及循环启动依赖

### 日志规范

- 日志大小
- 非大数据处理类程序，日志产生量不得大于 1G/天
- 大数据处理类程序，每 1W eps 流量日志量不得大于 1G/天
- 日志级别

### 端口开放

对外开放的端口见[端口列表]

- 不允许应用未经允许对外暴露端口
- 不允许应用与已有端口冲突

### 健康检查

无特殊情况，服务需要提供两种健康检查接口。

- livenessProbe
请求路径以"/actuator/health/liveness"为后缀
- readinessProbe
请求路径以"/actuator/health/readiness"为后缀

java使用needle开发会自带健康检查接口，无需额外开发。

### 兼容性

#### API接口

小版本内,**接口向前兼容, 请求方式以及业务含义保持一致**

#### 业务数据

小版本内,**数据模型向前兼容, 数据可以平滑升级到下个版本**

- pg: 通过flyway自行迁移
- es: 通过类似flyway机制自行迁移

### 优雅停机

程序支持优雅停机, 避免特殊的场景下产生脏数据。

- 支持程序停机时，自行进行关机处理
- 支持程序启动时，从上次关闭的任务中恢复或者重新执行原有任务

## 运维规范

### 禁止的操作

#### docker

- 禁止在重新安装docker
- 禁止任何环境（包括公司内部环境）下执行docker tag命令，禁止将重新tag的镜像push到仓库
- 禁止修改docker 配置(/etc/docker/daemon.json\~/.docker/config.json)
- 禁止不通过k8s控制docker(包括但不限于使用docker buildx、安装并使用docker-compose等)
- 禁止擅自修改docker二进制文件
- 禁止执行docker system prune命令

#### k8s

- 禁止修改/root/.kube 目录下任何文件
- 禁止修改k8s以及docker systemd配置
- 禁止修改etcd配置
- 禁止修改/etc/kubernetes 目录下任何配置
- 禁止在任何情况下，重启k8s关键组件(kubelet\kube-apiserver等)

#### 主机

- 禁止在任何情况下执行 reboot、poweroff等强制关机或者重启命令
- 禁止操作系统混部，禁止使用除及星海平台严格测试验证外的任何操作系统镜像，禁止使用公司禁止使用的操作系统镜像
- 禁止修改机器任何ansible相关配置
- 禁止开启机器的swap

#### 网络

- 禁止配置网卡dns
- 禁止配置dns search
- 禁止异构网卡设计，所有机器必须统一网卡名称、规格及作用，配置统一的网段
- 必须保证集群间任意一对机器的网卡间绝对互通且无阻塞
- 除初次部署需配置网卡的场景下，禁止修改网卡配置(/etc/sysconfig/network-scripts/ifcfg-*)
- 生成环境集群禁止使用千兆网卡、千兆交换机
- 禁止出现上游dns无法访问的情况；如果确实不满足全集群开通dns访问acl权限，需接受全集群无法访问外网的情况

#### 服务

- 禁止主动执行kill -9 xxx命令
- 禁止在任何情况下，先更新服务版本，然后看pod调度到哪个机器上给哪个机器导入镜像，必须给所有机器导入

### 需审批的操作

#### 主机

- 需确认，否则禁止修改任何iptables规则
- 需确认，否则禁止手动修改系统时间，以及重新配置系统时区

#### 服务

- 需确认，否则禁止修改/opt/xinghai目录下任何文件
- 需确认，否则禁止修改/usr/local/noah*目录下任何文件
- 需确认，否则禁止修改/data/s/service下任意文件内容，包括此目录下的日志文件
- 需确认，否则禁止安装任何不在k8s内部的服务
- 需确认，否则禁止修改coredns配置

## 测试规范

### 提测流程

- 项目人员: 前端开发，服务端开发，产品经理，项目经理，QA
- 提测内容: 描述本次提测的特性，以及本次提测的影响范围
- 提测补充说明: 描述本次提测的第三方依赖，以及集成组件测试文档链接，包括系统测试报告、性能测试报告、遗留BUG列表、测试用例。

### 功能性测试

- 测试需求覆盖率达到100%
- P0、P1、缺陷修复率为100%，p2、p3修复率≥90%
- 输出已完成评审的文档，包括系统测试报告、性能测试报告、遗留BUG列表、测试用例

### 性能&稳定性测试

- 性能：全部接口 10并发 2s内响应
- 稳定性：10并发稳定性测试运行7天

## 配置管理规范

参见配置管理计划

### 分支管理

遵循gitflow流程, 必须遵循公司配置管理要求，完成管理基线构建

### 文档规范

#### 架构设计文档

- 必须提供完整的架构设计文档
- 提供接口文档
- java服务通过swagger维护接口信息
- CI 自动生成接口文档以及接口SDK
- 其他语言服务可以手动维护接口文档
- 必须遵循公司配置管理要求，完成架构设计基线构建

#### 故障排查手册

- 必须提供完整、可行、有效的故障排查手册
- 必须遵循公司配置管理要求，完成故障排查手册基线构建
- 能够在程序出现问题时，及时更新故障排查手册